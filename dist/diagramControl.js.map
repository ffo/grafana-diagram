{"version":3,"sources":["../src/diagramControl.js"],"names":["getColorByXPercentage","canvas","xPercent","x","width","context","getContext","p","getImageData","data","color","TimeSeries","kbn","MetricsPanelCtrl","diagramEditor","displayEditor","compositeEditor","mappingEditor","_","panelDefaults","composites","metricCharacterReplacements","seriesOverrides","thresholds","decimals","colors","legend","show","min","max","avg","current","total","gradient","enabled","maxDataPoints","mappingType","maxWidth","nullPointMode","moddedSeriesVal","format","valueName","valueOptions","valueMaps","mappingTypes","name","value","content","mode","mermaidServiceUrl","init","logLevel","cloneCssStyles","startOnLoad","arrowMarkerAbsolute","flowchart","htmlLabels","useMaxWidth","sequenceDiagram","diagramMarginX","diagramMarginY","actorMargin","height","boxMargin","boxTextMargin","noteMargin","messageMargin","mirrorActors","bottomMarginAdj","gantt","titleTopMargin","barHeight","barGap","topPadding","leftPadding","gridLineStartPadding","fontSize","fontFamily","numberSectionStyles","DiagramCtrl","$scope","$injector","$sce","$http","defaults","panel","graphId","id","containerDivId","events","on","onInitEditMode","bind","onDataReceived","unitFormats","getUnitFormats","initializeMermaid","mermaidAPI","initialize","parseError","handleParseError","err","hash","error","errorText","trustAsHtml","addEditorTab","$","document","getElementById","dataList","console","debug","series","map","seriesHandler","setValues","svgData","updateDiagram","render","metricName","replacedText","replace","index","replacement","pattern","replacementPattern","length","stringToJsRegex","replaceWithText","seriesData","alias","replaceMetricCharacters","target","datapoints","unit","flotpairs","getFlotPairs","last","from","range","isOutsideRange","override","push","without","refresh","composite","ctrl","metrics","undefined","metric","mapping","type","valueToText","rangeToText","valueMap","thresholdCount","colorCount","colorIndex","splice","subItem","remove","svg","graphDefinition","substituteHashPrefixedNotation","templateSrv","diagramType","detectType","diagramContainer","_this","renderCallback","svgCode","bindFunctions","html","templatedURL","scopedVars","method","url","headers","then","successCallback","response","clearDiagram","renderDiagram","errorCallback","warn","matches","match","i","aMatch","valueType","substring","j","aComposite","displayedValue","valueRawFormattedWithPrefix","valueFormatted","valueFormattedWithPrefix","k","seriesItem","applyOverrides","lastPoint","lastValue","isArray","valueRounded","valueFormated","isString","escape","stats","decimalInfo","getDecimalsForValue","formatFunc","valueFormats","scaledDecimals","roundValue","getGradientForValue","colorData","getColorForValue","applyValueMapping","currentWorstSeries","currentWorstSeriesName","aMetric","seriesName","seriesDisplayName","displayName","hasOwnProperty","isSeriesWorse","series1","series2","series1thresholdLevel","getThresholdLevel","series2thresholdLevel","thresholdLevel","threshold","Math","apply","absoluteDistance","valueDistanceFromMin","invertColors","colorMap","seriesItemAlias","overrides","regex","split","strVale","Number","trim","slice","reverse","unitFormat","dataItem","valueMapping","text","parseFloat","rangeMapping","rangeNapping","to","isNumber","delta","dec","floor","log","LN10","magn","pow","norm","size","result","scope","elem","attrs","diagramElement","find","append","css","gradientValueMax","gradientValueMin","updateCanvasStyle","clientWidth","canvasContext","clearRect","grd","createLinearGradient","colorWidth","currentColor","addColorStop","fillStyle","fillRect","innerText","updateStyle","key","targetElement","d3","select","selectAll","style","div","fo","attr","classed","filter","parents","edgeElement","parent","addClass","dElement","renderingCompleted","templateUrl"],"mappings":"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","file":"diagramControl.js","sourcesContent":["import './libs/mermaid/dist/mermaidAPI';\nimport TimeSeries from 'app/core/time_series2';\nimport kbn from 'app/core/utils/kbn';\nimport {\n  MetricsPanelCtrl\n} from 'app/plugins/sdk';\nimport {\n  diagramEditor,\n  displayEditor,\n  compositeEditor,\n  mappingEditor\n} from './properties';\nimport _ from 'lodash';\nimport './series_overrides_diagram_ctrl';\nimport './css/diagram.css!';\n\nconst panelDefaults = {\n  composites: [],\n  metricCharacterReplacements: [],\n  // other style overrides\n  seriesOverrides: [],\n  thresholds: '0,10',\n  decimals: 2, // decimal precision\n  colors: ['rgba(50, 172, 45, 0.97)', 'rgba(237, 129, 40, 0.89)', 'rgba(245, 54, 54, 0.9)'],\n  legend: {\n    show: true,\n    min: true,\n    max: true,\n    avg: true,\n    current: true,\n    total: true,\n    gradient: {\n      enabled: true,\n      show: true\n    }\n  },\n  maxDataPoints: 100,\n  mappingType: 1,\n  maxWidth: false,\n  nullPointMode: 'connected',\n  moddedSeriesVal: 0,\n  format: 'none',\n  valueName: 'avg',\n  valueOptions: ['avg', 'min', 'max', 'total', 'current'],\n  valueMaps: [{\n  }],\n  mappingTypes: [\n    {name: 'value to text', value: 1},\n    {name: 'range to text', value: 2},\n  ],\n  content: 'graph LR\\n' +\n    'A[Square Rect] -- Link text --> B((Circle))\\n' +\n    'A --> C(Round Rect)\\n' +\n    'B --> D{Rhombus}\\n' +\n    'C --> D\\n',\n  mode: 'content', //allowed values: 'content' and 'url'\n  mermaidServiceUrl: '',\n  init: {\n    logLevel: 3, //1:debug, 2:info, 3:warn, 4:error, 5:fatal\n    cloneCssStyles: false, // - This options controls whether or not the css rules should be copied into the generated svg\n    startOnLoad: false, // - This options controls whether or mermaid starts when the page loads\n    arrowMarkerAbsolute: true, // - This options controls whether or arrow markers in html code will be absolute paths or an anchor, #. This matters if you are using base tag settings.\n    flowchart: {\n      htmlLabels: true,\n      useMaxWidth: true\n    },\n    sequenceDiagram: {\n      diagramMarginX: 50, // - margin to the right and left of the sequence diagram\n      diagramMarginY: 10, // - margin to the over and under the sequence diagram\n      actorMargin: 50, // - Margin between actors\n      width: 150, // - Width of actor boxes\n      height: 65, // - Height of actor boxes00000000001111\n      boxMargin: 10, // - Margin around l01oop boxes\n      boxTextMargin: 5, // - margin around the text in loop/alt/opt boxes\n      noteMargin: 10, // - margin around notes\n      messageMargin: 35, // - Space between messages\n      mirrorActors: true, // - mirror actors under diagram\n      bottomMarginAdj: 1, // - Depending on css styling this might need adjustment. Prolongs the edge of the diagram downwards\n      useMaxWidth: true, // - when this flag is set the height and width is set to 100% and is then scaling with the available space if not the absolute space required is used\n    },\n    gantt: {\n      titleTopMargin: 25, // - margin top for the text over the gantt diagram\n      barHeight: 20, // - the height of the bars in the graph\n      barGap: 4, // - the margin between the different activities in the gantt diagram\n      topPadding: 50, // - margin between title and gantt diagram and between axis and gantt diagram.\n      leftPadding: 75, // - the space allocated for the section name to the left of the activities.\n      gridLineStartPadding: 35, // - Vertical starting position of the grid lines\n      fontSize: 11, // - font size ...\n      fontFamily: '\"Open-Sans\", \"sans-serif\"', // - font family ...\n      numberSectionStyles: 3, // - the number of alternating section styles\n      /** axisFormatter: // - formatting of the axis, this might need adjustment to match your locale and preferences\n\t\t\t\t[\n\t\t        // Within a day\n\t\t        ['%I:%M', function (d) {\n\t\t            return d.getHours();\n\t\t        }],\n\t\t        // Monday a week\n\t\t        ['w. %U', function (d) {\n\t\t            return d.getDay() == 1;\n\t\t        }],\n\t\t        // Day within a week (not monday)\n\t\t        ['%a %d', function (d) {\n\t\t            return d.getDay() && d.getDate() != 1;\n\t\t        }],\n\t\t        // within a month\n\t\t        ['%b %d', function (d) {\n\t\t            return d.getDate() != 1;\n\t\t        }],\n\t\t        // Month\n\t\t        ['%m-%y', function (d) {\n\t\t            return d.getMonth();\n\t\t        }]] **/\n    },\n    //classDiagram: {},\n    //info: {}\n  }\n};\n\nclass DiagramCtrl extends MetricsPanelCtrl {\n  constructor($scope, $injector, $sce, $http) {\n    super($scope, $injector);\n    _.defaults(this.panel, panelDefaults);\n    this.$http = $http;\n    this.panel.graphId = 'diagram_' + this.panel.id;\n    this.containerDivId = 'container_' + this.panel.graphId;\n    this.$sce = $sce;\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n    this.unitFormats = kbn.getUnitFormats();\n    this.initializeMermaid();\n  }\n\n  initializeMermaid() {\n    mermaidAPI.initialize(this.panel.init);\n    mermaidAPI.parseError = this.handleParseError.bind(this);\n  }\n\n  handleParseError(err, hash) {\n    this.error = 'Failed to parse diagram definition';\n    this.errorText = this.$sce.trustAsHtml('<p>Diagram Definition:</p><pre>' + err + '</pre>');\n  }\n\n  onInitEditMode() {\n    this.addEditorTab('Diagram', diagramEditor, 2);\n    this.addEditorTab('Display', displayEditor, 3);\n    this.addEditorTab('Metric Composites', compositeEditor, 4);\n    this.addEditorTab('Value Mappings', mappingEditor, 5);\n  }\n\n  getDiagramContainer() {\n    return $(document.getElementById(this.containerDivId));\n  }\n\n  onDataReceived(dataList) {\n    console.debug('received data');\n    console.debug(dataList);\n    this.series = dataList.map(this.seriesHandler.bind(this));\n    console.debug('mapped dataList to series');\n    console.debug(this.series);\n    var data = this.setValues();\n    // this update works for local diagrams, if the url method is used the data has to be stored in the callback\n    this.svgData = data;\n    this.updateDiagram(data);\n    this.render();\n  }\n\n  replaceMetricCharacters(metricName) {\n    // a datasource sending bad data will have a type other than string, set it to \"MISSING_METRIC_TARGET\" and return\n    if (typeof metricName !== 'string') return \"DATASOURCE_SENT_INVALID_METRIC_TARGET\";\n    var replacedText = metricName.replace(/\"|,|;|=|:|{|}/g, '_');\n    for (var index in this.panel.metricCharacterReplacements) {\n      var replacement = this.panel.metricCharacterReplacements[index];\n      // start with a simple replacement\n      var pattern = replacement.replacementPattern;\n      // check if the pattern is empty\n      if (pattern.length === 0) continue;\n      // if it is a regex, convert\n      if (pattern[0] === '/') {\n        pattern = kbn.stringToJsRegex(replacement.replacementPattern);\n      }\n      replacedText = replacedText.replace(\n        pattern,\n        replacement.replaceWithText\n      );\n    }\n    return replacedText;\n  }\n\n  seriesHandler(seriesData) {\n    var alias = this.replaceMetricCharacters(seriesData.target);\n    var series = new TimeSeries({\n      datapoints: seriesData.datapoints,\n      alias: alias,\n      unit: seriesData.unit\n    });\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    var datapoints = seriesData.datapoints || [];\n    if (datapoints && datapoints.length > 0) {\n      var last = datapoints[datapoints.length - 1][1];\n      var from = this.range.from;\n      if (last - from < -10000) {\n        series.isOutsideRange = true;\n      }\n    }\n    return series;\n  } // End seriesHandler()\n\n  addSeriesOverride(override) {\n    this.panel.seriesOverrides.push(override || {});\n  }\n\n  removeSeriesOverride(override) {\n    this.panel.seriesOverrides = _.without(this.panel.seriesOverrides, override);\n    this.refresh();\n  }\n\n  addComposite(composite) {\n    this.panel.composites.push(composite || {});\n  }\n  removeComposite(composite) {\n    this.panel.composites = _.without(this.panel.composites, composite);\n    this.refresh();\n  }\n  getSeriesNamesForComposites() {\n    return _.map(this.$scope.ctrl.series, function(series) {\n      return series.alias;\n    });\n  }\n\n  addMetricToComposite(composite) {\n    if (composite.metrics === undefined) {\n      composite.metrics = [{}];\n    } else {\n      composite.metrics.push({});\n    }\n    this.refresh();\n  }\n  removeMetricFromComposite(composite, metric) {\n    composite.metrics = _.without(composite.metrics, metric);\n    this.refresh();\n  }\n\n  addMetricCharacterReplacement(replacement) {\n    this.panel.metricCharacterReplacements.push(replacement || {\n      replacementPattern: '',\n      replaceWithText: '_'\n    });\n  }\n  removeMetricCharacterReplacement(replacement) {\n    this.panel.metricCharacterReplacements = _.without(this.panel.metricCharacterReplacements, replacement);\n    this.refresh();\n  }\n\n\taddValueMapping(mapping) {\n\t\tthis.panel.valueMaps.push(mapping || {});\n\t}\n\n  removeValueMapping(mapping) {\n    this.panel.valueMaps = _.without(this.panel.valueMaps, mapping);\n  }\n\n  addEntryToValueMapping(mapping) {\n    if (mapping.type == 1) {\n      if (mapping.valueToText === undefined) {\n        mapping.valueToText = [{}];\n      } else {\n        mapping.valueToText.push({});\n      }\n    } else if (mapping.type == 2) {\n      if (mapping.rangeToText === undefined) {\n        mapping.rangeToText = [{}];\n      } else {\n        mapping.rangeToText.push({});\n      }\n    }\n  }\n\n  removeEntryFromValueMapping(valueMap, mapping) {\n    if (valueMap.type == 1) {\n      valueMap.valueToText = _.without(valueMap.valueToText, mapping);\n    } else if (valueMap.type == 2) {\n      valueMap.rangeToText = _.without(valueMap.rangeToText, mapping);\n    }\n  }\n\n  updateThresholds() {\n    var thresholdCount = this.panel.thresholds.length;\n    var colorCount = this.panel.colors.length;\n    this.refresh();\n  }\n\n  changeColor(colorIndex, color) {\n    this.panel.colors[colorIndex] = color;\n  }\n\n  removeColor(colorIndex) {\n    this.panel.colors.splice(colorIndex, 1);\n  }\n\n  addColor() {\n    this.panel.colors.push('rgba(255, 255, 255, 1)');\n  }\n\n  setUnitFormat(subItem) {\n    this.panel.format = subItem.value;\n    this.refresh();\n  }\n\n  clearDiagram() {\n    if ($('#'+this.panel.graphId).length) {\n      $('#' + this.panel.graphId).remove();\n    }\n    this.svg = {};\n  }\n\n  renderDiagram(graphDefinition, data) {\n    // substitute values inside \"link text\"\n    // this will look for any composite prefixed with a # and substitute the value of the composite\n    // if a series alias is found, in the form #alias, the value will be substituted\n    // this allows link values to be displayed based on the metric\n    graphDefinition = this.substituteHashPrefixedNotation(graphDefinition, data);\n    graphDefinition = this.templateSrv.replaceWithText(graphDefinition);\n    this.diagramType = mermaidAPI.detectType(graphDefinition);\n    var diagramContainer = $(document.getElementById(this.containerDivId));\n    var _this = this;\n    var renderCallback = function(svgCode, bindFunctions) {\n      if (svgCode === '') {\n        diagramContainer.html('There was a problem rendering the graph');\n      } else {\n        diagramContainer.html(svgCode);\n        bindFunctions(diagramContainer[0]);\n        console.debug(\"Inside rendercallback of renderDiagram\");\n        // svgData is empty when this callback happens, update it so the styles will be applied\n        _this.svgData = data;\n        // force a render or we will not see an update\n        _this.render();\n      }\n    };\n    // if parsing the graph definition fails, the error handler will be called but the renderCallback() may also still be called.\n    mermaidAPI.render(this.panel.graphId, graphDefinition, renderCallback);\n  }\n\n  updateDiagram(data) {\n    if (this.panel.content.length > 0) {\n      var mode = this.panel.mode;\n      if (mode == 'url') {\n        var templatedURL = this.templateSrv.replace(this.panel.mermaidServiceUrl, this.panel.scopedVars);\n        var _this = this;\n        this.$http({\n          method: 'GET',\n          url: templatedURL,\n          headers: { 'Accept': 'text/x-mermaid,text/plain;q=0.9,*/*;q=0.8' }\n        }).then(function successCallback(response) {\n          //the response must have text/plain content-type\n          // clearing the diagram here will result in less artifacting waiting for the response\n          _this.clearDiagram();\n          _this.renderDiagram(response.data, data);\n        }, function errorCallback(response) {\n          console.warn('error', response);\n        })\n      } else {\n        this.clearDiagram();\n        this.renderDiagram(this.panel.content, data);\n      }\n    }\n  } // End updateDiagram()\n\n\n\n  /**\n   * substitute values inside \"link text\"\n   * this will look for any composite prefixed with a #|!|@|& and substitute the value of the composite\n   * if a series alias is found, in the form #alias, the value will be substituted\n   * this allows link values to be displayed based on the metric\n   *\n   * Prefix Modifier For Composites\n   *   # Raw Value of Series\n   *   ! Raw Value plus Metric Name\n   *   @ Formatted (Decimal Limited and Unit Format)\n   *   & Formatted (Decimal Limited, Unit Format, and Metric Name)\n   *\n   * Prefix Modifier For Series\n   *   # Raw Value of Series\n   *   @ Formatted (Decimal Limited and Unit Format)\n   *\n   * @param  {[String]} graphDefinition [Content of Graph Definition Markdown]\n   * @param  {[Array]} data [Series Data]\n   * @return {[String]} [Modified Graph Definition]\n   */\n  substituteHashPrefixedNotation(graphDefinition, data) {\n    // inspect the string, locate all # prefixed items, and replace them with the value\n    // of the series. If no matching series is found, leave it alone\n    var matches = graphDefinition.match(/(?:#|!|@|&)(\\w+)/g);\n    if (matches === null) return graphDefinition;\n    // check if there is a composite with a matching name\n    for (var i = 0; i < matches.length; i++) {\n      var aMatch = matches[i];\n      var valueType = aMatch[0];\n      aMatch = aMatch.substring(1);\n      // check composites first\n      for (var j = 0; j < this.panel.composites.length; j++) {\n        var aComposite = this.panel.composites[j];\n        if (aComposite.name === aMatch) {\n          // found matching composite, get the valueFormatted\n          var displayedValue = null;\n          switch (valueType) {\n            case '#':\n              displayedValue = data[aComposite.name].value;\n              graphDefinition = graphDefinition.replace('#' + aMatch, displayedValue);\n              break;\n            case '!':\n              displayedValue = data[aComposite.name].valueRawFormattedWithPrefix;\n              graphDefinition = graphDefinition.replace('!' + aMatch, displayedValue);\n              break;\n            case '@':\n              displayedValue = data[aComposite.name].valueFormatted;\n              graphDefinition = graphDefinition.replace('@' + aMatch, displayedValue);\n              break;\n            case '&':\n              displayedValue = data[aComposite.name].valueFormattedWithPrefix;\n              graphDefinition = graphDefinition.replace('&' + aMatch, displayedValue);\n              break;\n          }\n        }\n      }\n      // next check series\n      for (var k = 0; k < this.series.length; k++) {\n        var seriesItem = this.series[k];\n        if (seriesItem.alias === aMatch) {\n          var displayedValue = null;\n          switch (valueType) {\n            case '#':\n              displayedValue = data[seriesItem.alias].value;\n              graphDefinition = graphDefinition.replace('#' + aMatch, displayedValue);\n              break;\n            case '@':\n              displayedValue = data[seriesItem.alias].valueFormatted;\n              graphDefinition = graphDefinition.replace('@' + aMatch, displayedValue);\n              break;\n          }\n        }\n      }\n    }\n    return graphDefinition;\n  }\n\n  setValues() {\n    var data = {};\n    if (this.series && this.series.length > 0) {\n      for (var i = 0; i < this.series.length; i++) {\n        var seriesItem = this.series[i];\n        console.debug('setting values for series');\n        console.debug(seriesItem);\n        data[seriesItem.alias] = this.applyOverrides(seriesItem.alias);\n        var lastPoint = _.last(seriesItem.datapoints);\n        var lastValue = _.isArray(lastPoint) ? lastPoint[0] : null;\n\n        if (this.panel.valueName === 'name') {\n          data[seriesItem.alias].value = 0;\n          data[seriesItem.alias].valueRounded = 0;\n          data[seriesItem.alias].valueFormated = seriesItem.alias;\n        } else if (_.isString(lastValue)) {\n          data[seriesItem.alias].value = 0;\n          data[seriesItem.alias].valueFormated = _.escape(lastValue);\n          data[seriesItem.alias].valueRounded = 0;\n        } else {\n          data[seriesItem.alias].value = seriesItem.stats[data[seriesItem.alias].valueName];\n          var decimalInfo = this.getDecimalsForValue(data[seriesItem.alias].value);\n          var formatFunc = kbn.valueFormats[data[seriesItem.alias].format];\n          // put the value in quotes to escape \"most\" special characters\n          data[seriesItem.alias].valueFormatted = formatFunc(data[seriesItem.alias].value, decimalInfo.decimals, decimalInfo.scaledDecimals);\n          data[seriesItem.alias].valueRounded = kbn.roundValue(data[seriesItem.alias].value, decimalInfo.decimals);\n        }\n        if (this.panel.legend.gradient.enabled) {\n          data[seriesItem.alias].color = this.getGradientForValue(data[seriesItem.alias].colorData, data[seriesItem.alias].value);\n        } else {\n          data[seriesItem.alias].color = this.getColorForValue(data[seriesItem.alias]);\n        }\n      }\n    }\n    // Map values to text if needed\n    this.applyValueMapping(data);\n    // now add the composites to data\n    for (var i = 0; i < this.panel.composites.length; i++) {\n      var aComposite = this.panel.composites[i];\n      var currentWorstSeries = null;\n      var currentWorstSeriesName = null;\n      for (var j = 0; j < aComposite.metrics.length; j++) {\n        var aMetric = aComposite.metrics[j];\n        var seriesName = aMetric.seriesName;\n        var seriesDisplayName = aMetric.displayName;\n        if (seriesDisplayName == null || seriesDisplayName.length == 0) {\n          seriesDisplayName = seriesName;\n        }\n        // For testing\n        console.debug(\"aMetric value: \" + seriesItem.valueFormatted);\n        console.debug(\"aMetric: \" + seriesName);\n        // make sure we have a match\n        if (!data.hasOwnProperty(seriesName)) continue;\n        var seriesItem = data[seriesName];\n        // check colorData thresholds\n        if (this.isSeriesWorse(currentWorstSeries, seriesItem)) {\n          currentWorstSeries = seriesItem;\n          currentWorstSeriesName = seriesDisplayName;\n        }\n      }\n      // Prefix the valueFormatted with the actual metric name\n      if (currentWorstSeries !== null) {\n        currentWorstSeries.valueFormattedWithPrefix = currentWorstSeriesName + ': ' + currentWorstSeries.valueFormatted;\n        currentWorstSeries.valueRawFormattedWithPrefix = currentWorstSeriesName + ': ' + currentWorstSeries.value;\n        currentWorstSeries.valueFormatted = currentWorstSeriesName + ': ' + currentWorstSeries.valueFormatted;\n        // now push the composite into data\n        data[aComposite.name] = currentWorstSeries;\n      }\n    }\n    return data;\n  } // End setValues()\n\n  isSeriesWorse(series1, series2) {\n    if (series1 == null) {\n      return true;\n    } else {\n      var series1thresholdLevel = this.getThresholdLevel(series1);\n      var series2thresholdLevel = this.getThresholdLevel(series2);\n      console.debug(\"threshold levels: 1=\" +series1thresholdLevel +\", 2=\" +series2thresholdLevel);\n      return (series2thresholdLevel > series1thresholdLevel);\n    }\n  }\n\n  // returns level of threshold, 0 = ok, 1 = warnimg, 2 = critical\n  getThresholdLevel(series) {\n    // default to ok\n    var thresholdLevel = 0;\n    var value = series.value;\n    var thresholds = series.colorData.thresholds;\n    // if no thresholds are defined, return 0\n    if (thresholds === undefined) {\n      return thresholdLevel;\n    }\n    for(var threshold in thresholds) {\n      if (value >= thresholds[threshold]) {\n        thresholdLevel += 1;\n      } else {\n        break;\n      }\n    }\n\n    // make sure thresholds is an array of size 2\n    //if (thresholds.length !== 2) {\n    //  return thresholdLevel;\n    //}\n    //if (value >= thresholds[0]) {\n    //  // value is equal or greater than first threshold\n    //  thresholdLevel = 1;\n    //}\n    //if (value >= thresholds[1]) {\n    //  // value is equal or greater than second threshold\n    //  thresholdLevel = 2;\n    //}\n    return thresholdLevel;\n  }\n\n  getGradientForValue(data, value) {\n    console.debug('Getting gradient for value');\n    console.debug(data);\n    console.debug(value);\n    var min = Math.min.apply(Math, data.thresholds);\n    var max = Math.max.apply(Math, data.thresholds);\n    var absoluteDistance = max - min;\n    var valueDistanceFromMin = value - min;\n    var xPercent = valueDistanceFromMin / absoluteDistance;\n    // Get the smaller number to clamp at 0.999 max\n    xPercent = Math.min(0.999, xPercent);\n    // Get the larger number to clamp at 0.001 min\n    xPercent = Math.max(0.001, xPercent);\n    if (data.invertColors) {\n      xPercent = 1 - xPercent;\n    }\n\n    return getColorByXPercentage(this.canvas, xPercent);\n  }\n\n  getColorForValue(series) {\n    console.debug('Getting color for value');\n\n    var colorMap = series.colorData.colorMap;\n    var thresholdLevel = this.getThresholdLevel(series);\n\n    if (colorMap.length >= thresholdLevel) {\n      return colorMap[thresholdLevel];\n    } else {\n      return _.last(colorMap)\n    }\n\n    //for (var i = data.thresholds.length; i > 0; i--) {\n    //  if (value >= data.thresholds[i - 1]) {\n    //    console.debug('Color['+(i-1)+']: ' + data.colorMap[i]);\n    //    return data.colorMap[i-1];\n    //    //return data.colorMap[i];\n    //  }\n    //}\n    //return _.first(data.colorMap);\n  }\n\n  applyOverrides(seriesItemAlias) {\n    var seriesItem = {},\n      colorData = {},\n      overrides = {};\n\n    console.debug('applying overrides for seriesItem');\n    console.debug(seriesItemAlias);\n    console.debug(this.panel.seriesOverrides);\n    for (var i = 0; i <= this.panel.seriesOverrides.length; i++) {\n      console.debug('comparing:');\n      console.debug(this.panel.seriesOverrides[i]);\n\n      if (this.panel.seriesOverrides[i]) {\n        var regex = kbn.stringToJsRegex(this.panel.seriesOverrides[i].alias);\n        var matches = seriesItemAlias.match(regex);\n        if (matches && matches.length > 0) {\n          overrides = this.panel.seriesOverrides[i];\n        }\n      }\n    }\n    colorData.thresholds = (overrides.thresholds || this.panel.thresholds).split(',').map(function(strVale) {\n      return Number(strVale.trim());\n    });\n    colorData.colorMap = this.panel.colors.slice();\n    colorData.invertColors = overrides.invertColors || false;\n    if (colorData.invertColors) {\n      colorData.colorMap.reverse();\n    }\n    seriesItem.colorData = colorData;\n\n    seriesItem.valueName = overrides.valueName || this.panel.valueName;\n\n    seriesItem.format = overrides.unitFormat || this.panel.format;\n    return seriesItem;\n  }\n\n\tapplyValueMapping(data) {\n\t\tfor (let i = 0; i < this.panel.valueMaps.length; i++) {\n\t\t\tvar map = this.panel.valueMaps[i];\n\t\t\tif (! map.hasOwnProperty('alias'))\n\t\t\t\tcontinue;\n\t\t\tvar regex = kbn.stringToJsRegex(map.alias);\n\t\t\tconsole.debug(\"Checking mapping: \" +map.alias);\n\t\t\tfor(let j = 0; j < this.series.length; j++) {\n\t\t\t\tvar matches = this.series[j].alias.match(regex);\n\t\t\t\tconsole.debug(\"  Series: \" +this.series[j].alias);\n\t\t\t\tif (matches && matches.length > 0) {\n\t\t\t\t\tvar seriesItem = this.series[j];\n\t\t\t\t\tvar dataItem = data[seriesItem.alias];\n\t\t\t\t\tif (map.type == 1) {\n\t\t\t\t\t\tfor(let k = 0; k < map.valueToText.length; k++) {\n\t\t\t\t\t\t\t\t//\t\n\t\t\t\t\t\t\t\t// Value mappings\n\t\t\t\t\t\t\t\t//\t\n\t\t\t\t\t\t\t\tvar valueMapping = map.valueToText[k];\n\t\t\t\t\t\t\t\tconsole.debug(\"    Mapping: \" +dataItem.valueFormatted +\" =? \" +valueMapping.value);\n\t\t\t\t\t\t\t\tif (valueMapping.value === 'null') {\n\t\t\t\t\t\t\t\t\tif (dataItem.value === null || dataItem.value === void 0) {\n\t\t\t\t\t\t\t\t\t\tdataItem.valueFormatted = valueMapping.text;\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t\t} else if (parseFloat(valueMapping.value) == dataItem.valueRounded) {\n\t\t\t\t\t\t\t\t\tdataItem.valueFormatted = valueMapping.text;\n\t\t\t\t\t\t\t\t\tconsole.debug(\"Map value of series \" +seriesItem.alias +\": \" +dataItem.valueRounded +\" -> \" +valueMapping.text);\n\t\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} else if (map.type == 2) {\n\t\t\t\t\t\tfor(let k = 0; k < map.rangeToText.length; k++) {\n\t\t\t\t\t\t\t\t//\t\n\t\t\t\t\t\t\t\t// Range Mappings\n\t\t\t\t\t\t\t\t//\t\n\t\t\t\t\t\t\t\tvar rangeMapping = map.rangeToText[k];\n\t\t\t\t\t\t\t\tif (rangeMapping.from === 'null' && rangeNapping.to == 'null') {\n\t\t\t\t\t\t\t\t\tif (dataItem.value === null || dataItem.value === void 0) {\n\t\t\t\t\t\t\t\t\t\tdataItem.valueFormatted = rangeMapping.text;\n\t\t\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t\t} else if (parseFloat(rangeMapping.from) <= dataItem.valueRounded && parseFloat(rangeMapping.to) >= dataItem.valueRounded) {\n\t\t\t\t\t\t\t\t\tdataItem.valueFormatted = rangeMapping.text;\n\t\t\t\t\t\t\t\t\tconsole.debug(\"Map value of series \" +seriesItem.alias +\": \" +dataItem.valueRounded +\" -> \" +rangeMapping.text);\n\t\t\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n  invertColorOrder() {\n    this.panel.colors.reverse();\n    this.refresh();\n  }\n\n  getDecimalsForValue(value) {\n    if (_.isNumber(this.panel.decimals)) {\n      return {\n        decimals: this.panel.decimals,\n        scaledDecimals: null\n      };\n    }\n\n    var delta = value / 2;\n    var dec = -Math.floor(Math.log(delta) / Math.LN10);\n\n    var magn = Math.pow(10, -dec),\n      norm = delta / magn, // norm is between 1.0 and 10.0\n      size;\n\n    if (norm < 1.5) {\n      size = 1;\n    } else if (norm < 3) {\n      size = 2;\n      // special case for 2.5, requires an extra decimal\n      if (norm > 2.25) {\n        size = 2.5;\n        ++dec;\n      }\n    } else if (norm < 7.5) {\n      size = 5;\n    } else {\n      size = 10;\n    }\n\n    size *= magn;\n\n    // reduce starting decimals if not needed\n    if (Math.floor(value) === value) {\n      dec = 0;\n    }\n\n    var result = {};\n    result.decimals = Math.max(0, dec);\n    result.scaledDecimals = result.decimals - Math.floor(Math.log(size) / Math.LN10) + 2;\n\n    return result;\n  }\n\n  link(scope, elem, attrs, ctrl) {\n    var templateSrv = this.templateSrv;\n    var diagramElement = elem.find('.diagram');\n    diagramElement.append('<div id=\"' + ctrl.containerDivId + '\"></div>');\n    var diagramContainer = $(document.getElementById(ctrl.containerDivId));\n    console.debug('found diagramContainer');\n    console.debug(diagramContainer);\n    elem.css('height', '100%');\n\n    var canvas = elem.find('.canvas')[0];\n    ctrl.canvas = canvas;\n    var gradientValueMax = elem.find('.gradient-value-max')[0];\n    var gradientValueMin = elem.find('.gradient-value-min')[0];\n\n    function updateCanvasStyle() {\n      canvas.width = Math.max(diagramElement[0].clientWidth, 100);\n      var canvasContext = canvas.getContext(\"2d\");\n      canvasContext.clearRect(0, 0, canvas.width, canvas.height);\n\n      var grd = canvasContext.createLinearGradient(0, 0, canvas.width, 0);\n      var colorWidth = 1 / Math.max(ctrl.panel.colors.length, 1);\n      for (var i = 0; i < ctrl.panel.colors.length; i++) {\n        var currentColor = ctrl.panel.colors[i];\n        grd.addColorStop(Math.min(colorWidth * i, 1), currentColor);\n      }\n      canvasContext.fillStyle = grd;\n      canvasContext.fillRect(0, 0, canvas.width, 3);\n      ctrl.canvasContext = canvasContext;\n\n      gradientValueMax.innerText = Math.max.apply(Math, ctrl.panel.thresholds.split(','));\n      gradientValueMin.innerText = Math.min.apply(Math, ctrl.panel.thresholds.split(','));\n    }\n    updateCanvasStyle(); // run once at beginning so the gradients are ready on first data\n\n    function updateStyle() {\n      var data = ctrl.svgData;\n      ctrl.svgData = {}; // get rid of the data after consuming it. This prevents adding duplicate DOM elements\n      console.debug('updating svg style');\n      var svg = $(document.getElementById(ctrl.panel.graphId));\n      $(svg).css('min-width', $(svg).css('max-width'));\n      if (ctrl.panel.maxWidth) {\n        $(svg).css('max-width', '100%');\n      }\n\n      if (svg[0] === undefined) {\n        return;\n      }\n\n      for (var key in data) {\n        var seriesItem = data[key];\n        \n        // Find nodes by ID if we can\n        //console.info('finding targetElement');\n        var targetElement = d3.select(svg[0].getElementById(key)); // $(svg).find('#'+key).first(); // jquery doesnt work for some ID expressions [prometheus data]\n        console.debug(\"Series item: \" + seriesItem.valueFormated);\n        if (targetElement[0][0] !== null) { // probably a flowchart\n          targetElement.selectAll('rect,circle,polygon').style('fill', seriesItem.color);\n\n          var div = targetElement.select('div');\n          var fo = targetElement.select('foreignObject');\n          // make foreign object element taller to accomdate value in FireFox/IE\n          fo.attr('height', 45);\n          // Add value text\n          var p = div.append('p');\n          p.classed('diagram-value');\n          p.style('background-color', seriesItem.color);\n          p.html(seriesItem.valueFormatted);\n        } else {\n          console.debug('finding element that contains id: ' + key);\n          // maybe a flowchart with an alias text node\n          targetElement = $(svg).find('div:contains(\"' + key + '\")').filter(function() {\n            // Matches node name ( 'foo' in both 'foo' and 'foo[bar]')\n            return $(this).attr('id') === key;\n          });\n          if (targetElement.length > 0) {\n            targetElement.parents('.node').find('rect, circle, polygon').css('fill', seriesItem.color);\n            // make foreign object element taller to accomdate value in FireFox/IE\n            targetElement.parents('.node').find('foreignObject').attr('height', 45);\n            // for edge matches\n            var edgeElement = targetElement.parent().find('.edgeLabel');\n            if (edgeElement.length > 0) {\n              edgeElement.css('background-color', 'transparent');\n              edgeElement.append('<br/>' + seriesItem.valueFormatted).addClass('diagram-value');\n              edgeElement.parent('div').css('text-align', 'center').css('background-color', seriesItem.color);\n            } else {\n              var dElement = d3.select(targetElement[0]);\n              // Add value text\n              var p = dElement.append('p');\n              p.classed('diagram-value');\n              p.style('background-color', seriesItem.color);\n              p.html(seriesItem.valueFormatted);\n            }\n          } else {\n            targetElement = $(svg).find('text:contains(\"' + key + '\")'); // sequence diagram, gantt ?\n            if (targetElement.length === 0) {\n              console.debug('couldnt not find a diagram node with id/text: ' + key);\n              continue;\n            }\n            // for node matches\n            targetElement.parent().find('rect, circle, polygon').css('fill', seriesItem.color);\n            targetElement.append('\\n' + seriesItem.valueFormatted);\n          }\n        }\n\n        console.debug(targetElement);\n        console.debug('set nodes:' + key + ' to color:' + seriesItem.color);\n      }\n      //return $(svg).html();\n    } // End updateStyle()\n\n     function render() {\n      updateCanvasStyle();\n      updateStyle();\n    }\n\n    this.events.on('render', function() {\n      render();\n      ctrl.renderingCompleted();\n    });\n  }\n}\n\nfunction getColorByXPercentage(canvas, xPercent) {\n  var x = canvas.width * xPercent;\n  var context = canvas.getContext(\"2d\");\n  var p = context.getImageData(x, 1, 1, 1).data;\n  var color = 'rgba(' + [p[0] + ',' + p[1] + ',' + p[2] + ',' + p[3]] + ')';\n  return color;\n}\n\nDiagramCtrl.templateUrl = 'module.html';\n\nexport {\n  DiagramCtrl,\n  DiagramCtrl as MetricsPanelCtrl\n};\n"]}